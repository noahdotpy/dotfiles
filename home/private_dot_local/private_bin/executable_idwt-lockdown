#!/usr/bin/env nu

def main [] {
    let choices = {
        "Block Internet for Current User": {
          id: "block-internet"
        }
        "Block Host": {
          id: "block-host"
        }
        "Remove Admin Privileges from Current User": {
          id: "unadmin"
        }
        "Block Networking for a Flatpak App": {
          id: "block-flatapp-net"
        }
        "Block URL in Chromium": {
          id: "chromium-block-url"
        }
    }
    let choices_names = $choices | columns
    
    let chosen = ugum choose --no-limit ...$choices_names --header "Choose which options you want for lockdown (empty to exit): " | str replace "\n" "," | split row ','
    let chosen_ids = $chosen | each {|chosen_name| $choices | get $chosen_name | get id}
    
    if ($chosen | is-empty) {
      exit
    }
    
    let confirm_response = ugum choose Yes No --header $"Lockdown with these options: '($chosen)'?)"
    
    if $confirm_response == "No" {
      notify-send --app-name "I Don't Want To" "Aborted Lockdown"
    }
      
    if "chromium-block-url" in $chosen_ids {
      let urls = ugum input --header="URLs separated by `,` (example: facebook.com)" --header.foreground="99" | split row ','
      for url in $urls {
        /usr/bin/idwt tighten config $'.chromium.block-urls += "($url)"'
      }
    }
    if "block-internet" in $chosen_ids {
      /usr/bin/idwt tighten config $'.user-networking.($env.USER).mode = "block"'
    }
    if "block-host" in $chosen_ids {
      # TODO: Allow multiple host blocks by entering them separated by commas (',')
      let hosts = ugum input --header="Hosts separated by `,` (example: facebook.com)" --header.foreground="99" | split row ','
      for host in $hosts {
        /usr/bin/idwt tighten config $'.block-hosts += "($host)"'
      }
    }
    if "unadmin" in $chosen_ids {
      /usr/bin/idwt tighten group remove $env.USER wheel
    }
    if "block-flatapp-net" in $chosen_ids {
      # TODO: Allow multiple flatpak app blocks by entering them separated by commas (',')
      let app_ids = ugum input --header="Flatpak ID (example: com.spotify.Client)" --header.foreground="99" | split row ','
      for app_id in $app_ids {
        /usr/bin/idwt tighten config $'.block-flatpak-networking.apps += "($app_id)"'
      }
    }
    
    notify-send --app-name "I Don't Want To" "Lockdown completed with these choices:" ($chosen | str join "\n") -u critical
}
